# 스레드 풀과 `Executor` 프레임워크2

## `ExecutorService` 종료
- 우아한 종료(Graceful shutdown)란, 서비스가 종료될 때 더 이상 새로운 요청을 받지 않으며 현재 진행 중이거나 대기 중인 작업을 모두 처리한 후 안전하게 종료되는 것을 의미함
- 우아한 종료를 사용하면 현재까지 들어온 사용자 요청을 모두 처리한 후 종료할 수 있어, 작업이 중간에 중단되는 것을 방지할 수 있음
- `ExecutorService`의 `shutdown()` 메서드는 우아한 종료를 수행함
- 반면 `shutdownNow()` 메서드는 실행 중인 작업을 즉시 중단하고, 대기 중인 작업을 리턴하며 강제 종료를 시도함
- 특정 작업이 오랫동안 끝나지 않는 경우, 우아한 종료까지 너무 오래걸릴 수 있음
- 이를 방지하기 위해 우아한 종료를 위한 대기 시간을 설정하고, 해당 시간이 지나도 종료되지 않은 작업들은 `shutdownNow()`를 통해 강제 종료하는 것이 적절함
- `ExecutorService`의 `close()` 메서드는 내부적으로 `shutdown()`을 호출한 뒤, 최대 하루 동안 작업이 완료되기를 기다린 후, 종료되지 않은 작업들을 `shutdownNow()`를 호출해 강제 종료함

<br>

## `Executor` 스레드 풀 관리
1. 초기 작업 요청이 들어오면, 코어 풀 사이즈(Core Pool Size)만큼 스레드가 생성되어 즉시 작업 처리
2. 코어 스레드가 모두 바쁠 상태에서 추가 작업 요청이 들어오면, 해당 작업은 큐에 저장됨
3. 큐가 가득 차 있을 경우, 최대 풀 사이즈(Maximum Pool Size)까지 추가 스레드를 생성하여 작업 처리
4. 큐가 가득 차고 현재 스레드 수가 최대 풀 사이즈에 도달한 상황에서 추가 작업 요청이 들어오면, 예외(`RejectedExecutionException`)가 발생하며 요청 거절 
5. 일정 유휴 시간 동안 추가 작업이 없으면, 스레드가 정리되어 코어 풀 사이즈만큼만 유지됨

> **참고**  
> 응답 시간이 중요한 서버라면, 사용자 요청을 받기 전 `ThreadPoolExecutor`의 `prestartAllCoreThreads()` 메서드로 스레드를 스레드 풀에 미리 생성해 둘 수 있음

<br>

## 스레드 풀 전략

### 단일 스레드 풀 전략
- `Executors.newSingleThreadExecutor()` 메서드로 생성할 수 있음
- 코어 스레드 1개만 사용함
- `LinkedBlockingQueue`를 사용하여 큐의 크기에 제한이 없음
- 주로 간단한 작업 처리나 테스트 용도로 사용됨 

### 고정 스레드 풀 전략
- `Executors.newFixedThreadPool(nThreads)` 메서드로 생성할 수 있음
- 고정된 수(`nThread`개)의 코어 스레드를 생성하며, `nThread`개 이상으로는 추가 스레드를 생성하지 않음
- `LinkedBlockingQueue`를 사용하여 큐의 크기에 제한이 없음 
- 스레드 수가 고정되어 있어, CPU 및 메모리 리소스 사용량이 예측 가능하므로 안정적인 서비스 운영이 가능함
- 그러나 사용자 수가 점차 증가하거나, 갑자기 많은 작업이 몰리는 경우 서비스 응답 속도가 느려질 수 있음
- 즉, 서버의 자원은 충분하지만 작업 처리가 지연되어 사용자 응답 속도가 저하되는 문제가 발생할 수 있음

### 캐시 스레드 풀 전략
- `Executors.newCachedThreadPool()` 메서드로 생성할 수 있음
- 코어 스레드가 0개이고, 추가 스레드 개수에는 제한이 없음
- 60초의 생존 주기를 가진 추가 스레드만 사용하며, 60초가 지나도록 유휴 상태이면 스레드는 제거됨
- 요청이 증가함에 따라 스레드 수도 빠르게 증가하고, 요청이 줄어들면 스레드 수도 함께 줄어듦
- 추가 스레드 수의 제한이 없으므로, CPU와 메모리 리소스가 허용하는 최대치까지 스레드가 생성될 수 있음
- `SynchronousQueue`를 사용해 큐에 작업을 저장하지 않고, 생산자 스레드가 소비자 스레드에게 작업을 직접 전달함
- 따라서 모든 요청을 대기 없이 처리할 수 있므으로 빠른 처리가 가능함
- 서버의 자원을 최대한 활용할 수 있지만, 무제한으로 스레드가 생성될 수 있기에 서버가 감당할 수 있는 임계점을 넘으면 시스템이 다운될 위험이 있음

### 커스텀 스레드 풀 전략 
- 상황에 따라 고정 스레드 풀 전략과 캐시 스레드 풀 전략의 장점을 결합한 커스텀 스레드 풀을 정의하여 사용할 수 있음
- 시스템이 감당할 수 없는 정도로 사용자 요청이 폭증할 경우, 최악의 상황인 시스템 다운을 방지하기 위해 처리 가능한 수준의 요청만 수락하고, 나머지 요청은 거절해야 함

> **Tip**  
> 스레드 풀 전략을 선택할 때, 미래를 예측한 과최적화보다는 현재 시스템 상황에 적합한 전략을 선택하는 것이 권장됨  
> 일반적으로 고정 스레드 풀 또는 캐시 스레드 풀 전략만으로도 충분히 안정적으로 시스템을 운영할 수 있음

<br>

## `Executor` 예외 정책
- `ThreadPoolExecutor`에 작업을 요청할 때, 큐가 가득차고 추가 스레드도 더 이상 할당할 수 없는 경우 작업을 거절함
- `ThreadPoolExecutor`는 작업을 거절할 때 사용 가능한 다양한 정책을 제공함

### `AbortPolicy`
- 기본 정책
- 새로운 작업이 제출될 때 `RejectedExecutionException` 예외를 발생시켜 작업을 거절함

### `DiscardPolicy`
- 새로운 작업을 아무 예외 없이 조용히 버림

### `CallerRunsPolicy`
- 새로운 작업을 제출한 스레드가 대신해서 직접 작업을 실행함
- 작업을 버리지 않고 처리할 방법이 없을 때 제출한 스레드가 직접 작업을 수행하므로 전체적인 성능은 떨어질 수 있음

### 커스텀
- 개발자가 직접 `RejectedExecutionHandler`를 구현하여 거절 정책을 정의할 수 있음
- 예를 들어, 로그를 기록하거나 특정 조건에 따라 다른 스레드 풀로 작업을 위임하는 등의 정책을 설정할 수 있음
