# 네트워크 - 프로그램2

## 셧다운 훅(Shutdown Hook)
- 자바에서 프로세스가 종료될 때, 자원 정리나 로깅 등 필요한 작업을 수행할 수 있도록 하는 기능

### 작동 시점
- 정상 종료: `System.exit()` 또는 프로그램의 모든 작업이 끝나 자연스럽게 종료될 때 작동
- 특정 강제 종료: `Ctrl+C`(`SIGINT`), `kill` 명령어로 전달된 `SIGTERM`, `SIGHUP` 시그널 등에서도 작동
- 강제 종료: `kill -9`로 전달되는 `SIGKILL` 시그널처럼 시스템이 즉시 프로세스를 종료할 때는 셧다운 훅 작동하지 않음

## 네트워크 예외
### 연결 예외
- `UnknownHostException`: 호스트를 알 수 없을 때(IP 주소나 도메인 이름이 잘못된 경우) 발생
- `ConnectException: Connection refused`: IP에 해당하는 서버는 작동하지만, 해당 포트에서 연결을 거부할 때(주로 사용 중인 포트가 없는 경우) 발생

### 타임아웃
- `ConnectException: Operation timed out`: TCP 연결 시도 중 서버가 바쁘거나 문제가 있어 연결 응답이 없을 때 발생
- `SocketTimeoutException: Read timed out`: TCP 연결은 성공했으나, 서버가 아무런 응답을 주지 않을때 발생

> **Tip**  
> 실무에서 자주 발생하는 장애 중 하나는 연결 타임아웃이나 소켓 타임아웃 설정을 누락하는 경우입니다.
> 예를 들어, 주문 서버가 외부 신용카드 회사의 서버와 통신할 때 특정 회사의 서버가 응답하지 않으면, 요청을 계속 기다리게 되어 장애가 발생할 수 있습니다.
> 주문 서버가 신용카드 A, B, C 회사와 각각 통신하는 상황을 가정해봅시다.  
>   
> 만약 신용카드 C 회사 서버에 문제가 있어 응답이 지연된다면, 그 서버와의 통신을 기다리는 스레드가 서버에 계속 쌓이게 됩니다.
> 이로 인해 결국 주문 서버에 장애가 발생하게 되며, 결과적으로 신용카드 C 때문에 신용카드 A, B를 사용하는 고객까지 모두 주문을 할 수 없는 사태가 벌어지게됩니다.  
>   
> 만약 주문 서버에 적절한 연결 타임아웃과 소켓 타임아웃을 설정했다면, 
> 신용카드 C 회사 서버에 문제가 발생했을때 타임아웃 처리로 요청을 빠르게 종료하고, 신용카드 A, B의 요청은 정상적으로 처리할 수 있습니다.
>   
> **따라서 외부 서버와 통신할 때는 반드시 연결 타임아웃(connect timeout)과 소켓 타임아웃(read timeout)을 설정해야 합니다.**

```java
Socket socket = new Socket();
socket.connect(new InetSocketAddress("example.com", 80), 5000);  // 연결 타임아웃 설정 (5초)
socket.setSoTimeout(5000);  // 소켓 타임아웃 설정 (5초)
```

### 종료
#### 정상 종료
- TCP 연결을 정상적으로 종료하려면 클라이언트와 서버가 서로 FIN 패킷을 주고받아야함
- 소켓이 FIN 패킷을 수신하면, 해당 소켓은 EOF(End Of File)을 통해 종료 신호를 감지할 수 있음

#### 강제 종료
- 네트워크 문제나 오류로 인해 TCP 연결에 문제가 발생하면 RST(Reset) 패킷이 전송됨
- RST 패킷은 현재 연결을 더이상 유지하지 않겠다는 의미로, 연결 상태를 초기화하고 즉시 종료해야함
- 만약 RST 패킷을 받은 소켓이 데이터를 읽거나 전송하려 하는 경우, `SocketException`이 발생함